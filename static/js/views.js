// Generated by CoffeeScript 1.3.3
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  window.FindPeopleView = Backbone.View.extend({
    el: "#find-people",
    events: {
      "keyup #thebox": "search",
      "click .create-group": "createGroup"
    },
    initialize: function() {
      return this.render();
    },
    render: function() {
      this.$el.show();
      return this.$el.html(Handlebars.templates.finder());
    },
    showGroups: function(models) {
      return this.$("#results").html(Handlebars.templates.foobar({
        groups: models
      }));
    },
    createGroup: function(e) {
      var error_cb, group, name, success_cb;
      name = $(e.target).data("name");
      group = new Group({
        name: name
      });
      success_cb = function() {
        groups.add(group);
        return router.navigate("/groups/" + group.id, true);
      };
      error_cb = function() {
        return alert("OH SHIT SOMETHING BROKE");
      };
      return group.save({}, {
        success: success_cb,
        error: error_cb
      });
    },
    search: function(e) {
      var fragment, matches;
      fragment = this.$("#thebox").val();
      if (fragment) {
        matches = groups.filter(function(group) {
          return ~group.get('name').indexOf(fragment);
        });
        if (matches.length > 0) {
          return this.showGroups(matches);
        } else {
          return this.$("#results").html(Handlebars.templates.no_groups({
            name: fragment
          }));
        }
      } else {
        return this.$("#results").html("Start typing <3");
      }
    },
    remove: function() {
      this.$el.hide();
      this.$el.children().remove();
      return this;
    }
  });

  window.FindGroupsView = Backbone.View.extend({
    el: "#find-groups",
    events: {
      "keyup #thebox": "search",
      "click .create-group": "createGroup"
    },
    initialize: function() {
      return this.render();
    },
    render: function() {
      this.$el.show();
      return this.$el.html(Handlebars.templates.finder());
    },
    showGroups: function(models) {
      return this.$("#results").html(Handlebars.templates.foobar({
        groups: models
      }));
    },
    createGroup: function(e) {
      var error_cb, group, name, success_cb;
      name = $(e.target).data("name");
      group = new Group({
        name: name
      });
      success_cb = function() {
        groups.add(group);
        return router.navigate("/groups/" + group.id, true);
      };
      error_cb = function() {
        return alert("OH SHIT SOMETHING BROKE");
      };
      return group.save({}, {
        success: success_cb,
        error: error_cb
      });
    },
    search: function(e) {
      var fragment, matches;
      fragment = this.$("#thebox").val();
      if (fragment) {
        matches = groups.filter(function(group) {
          return ~group.get('name').indexOf(fragment);
        });
        if (matches.length > 0) {
          return this.showGroups(matches);
        } else {
          return this.$("#results").html(Handlebars.templates.no_groups({
            name: fragment
          }));
        }
      } else {
        return this.$("#results").html("Start typing <3");
      }
    },
    remove: function() {
      this.$el.hide();
      this.$el.children().remove();
      return this;
    }
  });

  window.GroupView = Backbone.View.extend({
    el: "#group",
    color_bank: ["#C91371", "#6477CA", "#869A80", "#F79B06", "#CE9F9F", "#1EA3D2", "#A2C085", "#87BB06", "#BD1FFC", "#3FCECB", "#F8D19E", "#48EE59", "#A8E947", "#11A0E1", "#DAD2AD", "#FAC528", "#D92A53", "#EED516", "#F3322A", "#579C94"],
    colors: {},
    events: {
      "keyup #chat-input": "addMessage"
    },
    initialize: function() {
      return this.render();
    },
    render: function() {
      this.$el.show();
      this.$('.inner').html(Handlebars.templates.group(this.colorize(this.model.toJSON())));
      this.$("#messages").scrollTop(1234567890);
      this.$("#chat-input").focus();
      this.model.set({
        unread: 0
      });
      return app.updateGroupList();
    },
    getColor: function(username) {
      if (!_.has(this.colors, username)) {
        this.colors[username] = this.color_bank[Math.floor(Math.random() * this.color_bank.length)];
      }
      return this.colors[username];
    },
    colorize: function(group) {
      var colorized,
        _this = this;
      colorized = [];
      _.each(group.messages, function(message) {
        message.color = _this.getColor(message.username);
        return colorized.push(message);
      });
      group.messages = colorized;
      return group;
    },
    pushMessage: function(message) {
      var str;
      str = '<p><span style="color:' + this.getColor(message.username) + '">' + message.username + ': </span>' + message.body + '</p>';
      this.$("#messages").append(str);
      return this.$("#messages").scrollTop(1234567890);
    },
    addMessage: function(e) {
      var message,
        _this = this;
      if (e.keyCode === 13) {
        message = this.$(e.target).val();
        this.$(e.target).val('');
        if (message) {
          return socket.emit("group:message", this.model.id, message, function(err, res) {
            if (err) {
              return alert("FUCK FUCK SOMETHING BROKE OH SHIT");
            } else {
              return _this.render;
            }
          });
        }
      }
    },
    remove: function() {
      this.$el.hide();
      this.$el.children().empty();
      this.undelegateEvents();
      return this;
    }
  });

  window.AppView = Backbone.View.extend({
    el: "body",
    username: null,
    events: {
      "click a[data-route]": "routeInternal"
    },
    initialize: function() {
      var _this = this;
      this.updateGroupList();
      router.on('highlight', this.highlightSidebar, this);
      groups.on("add remove", this.updateGroupList, this);
      socket.on("online", function(people) {
        console.log(people);
        return _this.updatePersonList(people);
      });
      return socket.on("message", function(data) {
        var group;
        group = groups.get(data.group);
        group.get('messages').push(data.message);
        if (router.current_view.model.id === group.id) {
          console.log("We're currently viewing this group");
          return router.current_view.pushMessage(data.message);
        } else {
          console.log("Not currently viewing");
          group.set({
            unread: group.get('unread') + 1
          });
          return _this.updateGroupList();
        }
      });
    },
    routeInternal: function(e) {
      var href, protocol, target;
      target = $(e.target);
      href = target.attr("href");
      protocol = window.location.protocol + "//";
      if (href && href[{
        0: protocol.length
      }] !== protocol && __indexOf.call(href, "javascript:") < 0) {
        e.preventDefault();
        return router.navigate(href, true);
      }
    },
    updateGroupList: function() {
      this.$("#groups").html(Handlebars.templates.sidebar_groups({
        groups: groups.toJSON()
      }));
      return this.highlightSidebar();
    },
    updatePersonList: function(people) {
      return this.$("#people").html(Handlebars.templates.sidebar_people({
        people: people
      }));
    },
    highlightSidebar: function() {
      this.$('li.active:not(.nav-link)').removeClass('active');
      return this.$("a[href='/" + Backbone.history.fragment + "']").parent().addClass('active');
    }
  });

}).call(this);
